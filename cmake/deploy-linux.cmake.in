set(IVW_PACKAGE_SELECT_APP "@IVW_PACKAGE_SELECT_APP@")

# First download and install LinuxDeployQt
# See https://github.com/probonopd/linuxdeployqt#using-linuxdeployqt-with-travis-ci
set(LINUXDEPLOYQT_URL "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage")
set(LINUXDEPLOYQT_APPIMAGE ${CMAKE_CURRENT_BINARY_DIR}/linuxdeployqt-continuous-x86_64.AppImage)
set(LINUXDEPLOYQT ${CMAKE_CURRENT_BINARY_DIR}/linuxdeployqt/AppRun)

add_custom_command(
    OUTPUT
        ${LINUXDEPLOYQT}
    COMMAND
        wget ${LINUXDEPLOYQT_URL}
    COMMAND
        chmod a+x ${LINUXDEPLOYQT_APPIMAGE}
    COMMAND
        ${LINUXDEPLOYQT_APPIMAGE} --appimage-extract)

# Run LinuxDeployQt
set(APP_BUNDLE_PATH "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/share/applications/${IVW_PACKAGE_SELECT_APP}.desktop")
set(COMMAND_ARGS
    ${LINUXDEPLOYQT}
    ${APP_BUNDLE_PATH}
    -verbose=2
    -bundle-non-qt-libs
    -always-overwrite
)
execute_process(COMMAND ${COMMAND_ARGS} RESULT_VARIABLE EXIT_CODE)
if(NOT EXIT_CODE EQUAL 0)
    message(FATAL_ERROR
        \"Running ${COMMAND_ARGS} failed with exit code \${EXIT_CODE}.\")
endif()

